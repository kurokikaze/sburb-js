<!DOCTYPE html>
<head>	
	<script type="text/javascript" src="crafty.js"></script>
	<title>SBURB</title>
</head><!-- 84x138 -->
<body>
	<script type="text/javascript">
	window.onload = function () {
		Crafty.init(650, 450);

		Crafty.scene("loading", function () {
			//load takes an array of assets and a callback when complete
			Crafty.load(["egbert_room.gif", "jake_necessary.gif"], function () {
				//Crafty.sprite(81, 127, "jade_small.gif", {
				//	player: [0, 0]
				//});
				Crafty.sprite(84, 138, "jake_necessary.gif", {
					player: [0, 0],
					player_turnwise: [5, 0],
				});
				
				Crafty.sprite(63, 34, "hammer_nails.gif", {
					hammer: [0, 0],
					nails: [1, 0],
					empty: [0, 1],
					red: [1, 1],
				});
				
				Crafty.sprite(45, 145, "cd_rack.gif", {
					cd_rack: [0, 0]
				});
				
				Crafty.sprite(103, 207, "con_air_poster.gif", {
					con_air_poster: [0, 0]
				});
				
				Crafty.sprite(212, 187, "pc_table.gif", {
					pc_table: [0, 0]
				});
				
				Crafty.sprite(165, 181, "cupboard.gif", {
					cupboard: [0, 0]
				});
				
				Crafty.sprite(265, 173, "johns_bed.gif", {
					johns_bed: [0, 0]
				});
				
				Crafty.sprite(171, 132, "chest_flat.gif", {
					magician_chest: [0, 0],
				});
				
				Crafty.scene("main"); //when everything is loaded, run the main scene
			});

			//black background with some loading text
			Crafty.background("#000");
			Crafty.e("2D, DOM, Text").attr({ w: 100, h: 20, x: 150, y: 120 })
					.text("SBURB Loading")
					.css({ "text-align": "center" });
		});
		
		Crafty.c("LeftControls", {
			init: function() {
				this.requires('Multiway');
			},
			
			leftControls: function(speed) {
				this.multiway(speed, {W: -90, S: 90, D: 0, A: 180});
				return this;
			}
			
		});
		
		Crafty.c('Item', {
			Item: function(bound_box) {
				this.requires("Collision, Grid")
				.collision(bound_box);
				return this;
			}
			
		});
		
		Crafty.c('sylladex_card', {
			sylladex_card: function() {
				// 1000 is for sylladex overlay
				this.requires('2D, DOM, Image').image('sylladex-card.gif').attr({'y':381,'z':1001});
				this.item = false;
				return this;
			},
			store: function(entity) {
				if (!this.item) {
					this.item = entity;
				}
				return this;
			},
			retrieve: function() {
				var item = this.item;
				this.item = false;
				return item;
			}
		});
		
		Crafty.c('Sylladex', {
			Sylladex: function() {
				this.sylladex_size = 4;
				this.cards = [];
				this.drawn_size = 0;
				this.requires('2D, DOM, Image').attr({'x':0, 'y':350, 'w':650,'h':100,'z':1000}).image('sylladex-overlay.gif');
				this.visible = false;
				
				return this;
			},
			actualize: function() {
				if (this.drawn_size < this.sylladex_size) {
					var new_size = this.sylladex_size * 47 + (this.sylladex_size - 1) * 8;
					var left_boundary = this.x + (this.w / 2 - new_size / 2);
					for (var i = 0; i < this.sylladex_size - this.drawn_size; i++) {
						this.cards.push(Crafty.e('sylladex_card').sylladex_card().attr({'x':(left_boundary + i * (47+8)), 'visible':this.visible}));
					}
				}
				return this;
			},
			setsize: function(new_size) {
				this.sylladex_size = new_size;
			},
			hide: function() {
				this.visible = false;
				for (card_id in this.cards) {
					this.cards[card_id].visible = false;
				}
				return this;
			},
			show: function() {
				this.visible = true;
				for (card_id in this.cards) {
					this.cards[card_id].visible = true;
				}
				return this;
			}
		});
		
		Crafty.c('Thing', {
			Thing: function(bound_box) {
				this.requires("Draggable, Canvas")
				.startDrag(function() {
					this.tint("#969696", 0.3)
				})
				.stopDrag(function() {
					this.tint("#969696", 0)
				});
				return this;
			}
			
		});
		
		Crafty.c('Human', {
			Human: function() {
				//setup animations
				var dir_last = 'right';
				this.requires("SpriteAnimation, Collision, Grid")
				.animate("walk_left", 3, 0, 4)
				.animate("walk_right", 1, 0, 2)
				.collision([18,99], [18, 99+18], [18+55,99+18],[18+55,99])
				//.animate("walk_up", 3, 3, 5)
				//.animate("walk_down", 0, 3, 2)
				.bind("NewDirection", //change direction when a direction change event is received
					function (direction) {
						if (direction.x < 0) {
							if (!this.isPlaying("walk_left"))
								this.stop().animate("walk_left", 10, -1);
								dir_last = 'left';
						}
						if (direction.x > 0) {
							if (!this.isPlaying("walk_right"))
								this.stop().animate("walk_right", 10, -1);
								dir_last = 'right';
						}
						if (direction.y < 0 || direction.y > 0) {
							if (dir_last == 'right') {
								if (!this.isPlaying("walk_right"))
									this.stop().animate("walk_right", 10, -1);
							} else {
								if (!this.isPlaying("walk_left"))
									this.stop().animate("walk_left", 10, -1);							
							}
						}
						if(!direction.x && !direction.y) {
							if (dir_last == 'right') {
								this.stop().sprite(0,0);
							} else {
								this.stop().sprite(5,0);
							}
						}
				})
				.onHit("Item", function () {
					//Move unit out of solid tile
					console.log('Solid: ');
				})
				.bind('Moved', function(from) {
					this.z = this._y;
					col_obj = this.hit('Item');
					if (col_obj){
						console.log('Solid (' + col_obj.length + '): ' + col_obj[0].type);
						if (col_obj[0].type == 'SAT') {
							this.attr({x: from.x, y:from.y});
						}
					}
				})
				.onHit("fire", function() {
					this.destroy();
				// Subtract life and play scream sound :-)
				});
				return this;
			}
		});
		Crafty.scene("main",function() {
			Crafty.background('url("egbert_room.gif")');
			var iso = Crafty.isometric.size(64);//.centerAt(10,10);
			var area = iso.area(); //get the area
			/*for(var y = area.y.start;y <= area.y.end;y++){
			  for(var x = area.x.start ;x <= area.x.end;x++){
				//if (x == 3) {
				  iso.place(x,y,0,Crafty.e("2D, DOM, Text").text("[" + x + ":" + y + "]")); //Display tiles in the Screen
				//  }
				  
			  }
			}*/
			//var player1 = ;;
			/* Walls */
			Crafty.e("2D, DOM, Item").Item(new Crafty.polygon([0,0], [297,0], [297,170], [0,298])).attr({"x":0,"y":0,"w":298,"h":298});
			Crafty.e("2D, DOM, Item").Item(new Crafty.polygon([7,0], [7,170], [360,290], [360,0])).attr({"x":290,"y":0,"w":353,"h":290});
			Crafty.e("2D, DOM, Item").Item(new Crafty.polygon([0,96], [184,96], [184,0])).attr({"x":466,"y":354,"w":184,"h":96});
			Crafty.e("2D, DOM, Item").Item(new Crafty.polygon([0,0], [223,100], [0,100])).attr({"x":0,"y":350,"w":223,"h":100});
			
			Crafty.e("2D, DOM, con_air_poster").attr({"x":190,"y":-35,"z":1});
			Crafty.e("2D, DOM, Human, player, LeftControls")
				.attr({ x: 139, y: 144, z: 144 })				
				.leftControls(3)
				.Human();
			
			Crafty.e("2D, DOM, Item, magician_chest").Item(new Crafty.polygon([8,89],[95,130],[162,96],[93,48])).attr({x:510, y:230, z:212});
			Crafty.e("2D, DOM, Item, cd_rack").Item(new Crafty.polygon([1,133],[24,144],[43,130],[22,119])).attr({x:183, y:285, z:300});
			iso.place(3,17,0, Crafty.e("2D, DOM, Item, pc_table").Item(new Crafty.polygon([5,172],[80,120],[210,187],[23,187])).attr({z:340}));
			Crafty.e("2D, DOM, Item, cupboard").Item(new Crafty.polygon([1,129],[77,170],[160,128],[77,98])).attr({x:-20, y: 200, z:220});
			Crafty.e("2D, DOM, Item, johns_bed").Item(new Crafty.polygon([1,110],[159,172],[261,120],[124,63])).attr({x:192, y: 113, z:120});
			
			Crafty.e("Sylladex").Sylladex();
			
			iso.place(6,15,0, Crafty.e("2D, Thing, hammer").Thing());
			iso.place(7,16,1, Crafty.e("2D, DOM, nails"));
			
		});
		
		// YOUR GAME CODE
		Crafty.scene("loading");
	};
	</script>
</body>
</html>